# name: deops_pipeline_practice
# on:
#   workflow_dispatch:  # Fixed typo: workflow_dipatch -> workflow_dispatch
#     inputs:
#       branch_name:
#         required: true
#         description: "provide the branch_name"
#         type: choice
#         options:
#           - main
#       tag:
#         description: "provide the tag"
#         required: true
#         type: string  # Fixed: environment -> string (environment is not a valid input type)
        
# jobs:
#   dev_job:
#     name: dev job running
#     runs-on: ubuntu-latest  # Fixed: run_on -> runs-on
#     steps:  # Fixed: step -> steps
#     - name: checkout code
#       uses: actions/checkout@v4
#       with:  # Added to specify branch based on input
#         ref: ${{ inputs.branch_name }}
        
#     - name: build docker image  # Better step name
#       run: |
#         echo "code build"
#         docker build -t venky:${{ inputs.tag }} .  # Using input tag
#         docker images
# jobs:
#   dev_job:
#     name: dev job running
#     runs-on: ubuntu-latest  # Fixed: run_on -> runs-on
#     steps:  # Fixed: step -> steps
#     - name: checkout code
#       uses: actions/checkout@v4
#       with:  # Added to specify branch based on input
#         ref: ${{ inputs.branch_name }}
        
#     - name: build docker image  # Better step name
#       run: |
#         echo "code build"
#         docker build -t venky:${{ inputs.tag }} .  # Using input tag
#         docker images

name: deops_pipeline_practice
on:
  workflow_dispatch:
    inputs:
      branch_name:
        required: true
        description: "provide the branch_name"
        type: choice
        options:
          - main
          - venky
      tag:
        description: "provide the tag"
        required: true
        type: string
        
jobs:
  # Stage 1: Build and Test
  build-stage:
    name: Build Docker Image
    runs-on: ubuntu-latest
    outputs:
      image-tag: ${{ steps.tag.outputs.image-tag }}
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        ref: ${{ inputs.branch_name }}
        
    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v3
      
    - name: Build Docker image
      run: |
        echo "Building Docker image from branch: ${{ inputs.branch_name }}"
        docker build -t venky:${{ inputs.tag }} .
        docker images
        
    - name: Generate image tag
      id: tag
      run: |
        echo "image-tag=venky:${{ inputs.tag }}" >> $GITHUB_OUTPUT
        
    - name: Test Docker image
      run: |
        echo "Testing the built image"
        docker run --rm venky:${{ inputs.tag }} echo "Image test successful!"

  # Stage 2: Security Scan (depends on build)
  security-scan:
    name: Security Scan
    runs-on: ubuntu-latest
    needs: build-stage  # Depends on build-stage
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Run security scan
      run: |
        echo "Running security scan for image: ${{ needs.build-stage.outputs.image-tag }}"
        # Add your security scanning tools here
        echo "Security scan completed"

  # Stage 3: Deploy to Environment (depends on security-scan)
  deploy-stage:
    name: Deploy Application
    runs-on: ubuntu-latest
    needs: [build-stage, security-scan]  # Depends on both previous jobs
    if: always()  # Run even if previous jobs fail (for cleanup)
    
    steps:
    - name: Deploy application
      run: |
        echo "Deploying image: ${{ needs.build-stage.outputs.image-tag }}"
        echo "Deployment to environment completed"
        
    - name: Cleanup
      if: always()
      run: |
        echo "Cleaning up resources"
        docker system prune -f